# CryptoServe Policy Validation Workflow
#
# This workflow validates that your code's cryptographic choices
# comply with organizational policies before merging.
#
# Usage:
#   1. Copy this file to your repo's .github/workflows/
#   2. Configure the policy checks for your contexts
#   3. PRs will be blocked if policy violations are detected

name: Crypto Policy Check

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]
  # Allow manual triggers for testing
  workflow_dispatch:
    inputs:
      algorithm:
        description: 'Algorithm to check'
        required: false
        default: 'AES-256-GCM'
      context:
        description: 'Context to check'
        required: false
        default: 'general'

env:
  CRYPTOSERVE_API_URL: ${{ secrets.CRYPTOSERVE_API_URL }}
  CRYPTOSERVE_API_KEY: ${{ secrets.CRYPTOSERVE_API_KEY }}

jobs:
  # ============================================================================
  # Option 1: Using the CLI tool directly
  # ============================================================================
  policy-check-cli:
    name: Policy Check (CLI)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install CryptoServe CLI
        run: |
          pip install pyyaml
          # In a real setup, you'd install from PyPI or your artifact repo:
          # pip install cryptoserve-cli

          # For this example, we'll clone and use the CLI directly
          git clone https://github.com/your-org/crypto-serve.git /tmp/crypto-serve
          chmod +x /tmp/crypto-serve/backend/cryptoserve-policy

      - name: Validate policy files
        if: hashFiles('policies/*.yaml') != ''
        run: |
          echo "::group::Validating policy files"
          for file in policies/*.yaml; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              /tmp/crypto-serve/backend/cryptoserve-policy --format github validate "$file"
            fi
          done
          echo "::endgroup::"

      - name: Check PII data context
        run: |
          /tmp/crypto-serve/backend/cryptoserve-policy --format github check \
            --algorithm AES-256-GCM \
            --context user-pii \
            --pii \
            --frameworks GDPR,CCPA

      - name: Check payment data context
        run: |
          /tmp/crypto-serve/backend/cryptoserve-policy --format github check \
            --algorithm AES-256-GCM \
            --context payment-data \
            --sensitivity critical \
            --frameworks PCI-DSS

      - name: Check health data context
        run: |
          /tmp/crypto-serve/backend/cryptoserve-policy --format github check \
            --algorithm AES-256-GCM \
            --context health-data \
            --pii \
            --frameworks HIPAA

      - name: Check quantum readiness for long-term secrets
        run: |
          # This will show a warning but not block
          /tmp/crypto-serve/backend/cryptoserve-policy --format github check \
            --algorithm AES-256-GCM+ML-KEM-768 \
            --context quantum-ready \
            --sensitivity critical \
            --lifetime 30

  # ============================================================================
  # Option 2: Using the API directly
  # ============================================================================
  policy-check-api:
    name: Policy Check (API)
    runs-on: ubuntu-latest
    if: ${{ vars.USE_API_CHECK == 'true' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check policies via API
        run: |
          # Evaluate policies for your application's contexts
          contexts=(
            '{"algorithm":"AES-256-GCM","context_name":"user-pii","pii":true,"frameworks":["GDPR","CCPA"]}'
            '{"algorithm":"AES-256-GCM","context_name":"payment-data","sensitivity":"critical","pci":true,"frameworks":["PCI-DSS"]}'
            '{"algorithm":"AES-256-GCM","context_name":"health-data","phi":true,"frameworks":["HIPAA"]}'
          )

          exit_code=0

          for ctx in "${contexts[@]}"; do
            echo "Evaluating: $ctx"

            response=$(curl -s -X POST \
              "${CRYPTOSERVE_API_URL}/api/policies/evaluate" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${CRYPTOSERVE_API_KEY}" \
              -d "$ctx")

            allowed=$(echo "$response" | jq -r '.allowed')
            blocking=$(echo "$response" | jq -r '.blocking_violations')
            warnings=$(echo "$response" | jq -r '.warning_violations')

            if [ "$allowed" = "false" ]; then
              echo "::error::Policy violation detected: $blocking blocking violation(s)"
              echo "$response" | jq -r '.results[] | select(.passed == false) | "  - [\(.policy_name)] \(.message)"'
              exit_code=1
            elif [ "$warnings" -gt 0 ]; then
              echo "::warning::$warnings warning(s) detected"
              echo "$response" | jq -r '.results[] | select(.passed == false and .severity == "warn") | "  - [\(.policy_name)] \(.message)"'
            else
              echo "All policies passed"
            fi

            echo ""
          done

          exit $exit_code

  # ============================================================================
  # Option 3: Scan code for crypto usage patterns
  # ============================================================================
  crypto-usage-scan:
    name: Crypto Usage Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for deprecated algorithms
        run: |
          echo "::group::Scanning for deprecated algorithm usage"

          # List of deprecated algorithms
          deprecated=("DES" "3DES" "MD5" "SHA1" "RC4" "AES-128-ECB" "Blowfish")

          exit_code=0

          for algo in "${deprecated[@]}"; do
            # Search for algorithm mentions in code (excluding comments and docs)
            matches=$(grep -rn --include="*.py" --include="*.js" --include="*.ts" --include="*.java" --include="*.go" \
              -E "(encrypt|cipher|algorithm|crypto).*${algo}" . 2>/dev/null || true)

            if [ -n "$matches" ]; then
              echo "::error::Found deprecated algorithm '${algo}' in code:"
              echo "$matches" | while read -r line; do
                file=$(echo "$line" | cut -d: -f1)
                linenum=$(echo "$line" | cut -d: -f2)
                echo "::error file=${file},line=${linenum}::Deprecated algorithm ${algo} detected"
              done
              exit_code=1
            fi
          done

          if [ $exit_code -eq 0 ]; then
            echo "No deprecated algorithms found"
          fi

          echo "::endgroup::"
          exit $exit_code

      - name: Check for hardcoded keys
        run: |
          echo "::group::Scanning for potential hardcoded keys"

          # Common patterns for hardcoded keys (simplified)
          patterns=(
            'key\s*=\s*["\x27][A-Za-z0-9+/=]{32,}["\x27]'
            'secret\s*=\s*["\x27][A-Za-z0-9+/=]{16,}["\x27]'
            'api_key\s*=\s*["\x27][A-Za-z0-9_-]{20,}["\x27]'
          )

          for pattern in "${patterns[@]}"; do
            matches=$(grep -rn --include="*.py" --include="*.js" --include="*.ts" -E "$pattern" . 2>/dev/null | \
              grep -v "test" | grep -v "example" | grep -v "mock" || true)

            if [ -n "$matches" ]; then
              echo "::warning::Potential hardcoded secret found:"
              echo "$matches"
            fi
          done

          echo "::endgroup::"

  # ============================================================================
  # Summary job
  # ============================================================================
  summary:
    name: Policy Check Summary
    runs-on: ubuntu-latest
    needs: [policy-check-cli, crypto-usage-scan]
    if: always()

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.policy-check-cli.result }}" = "failure" ] || \
             [ "${{ needs.crypto-usage-scan.result }}" = "failure" ]; then
            echo "::error::One or more policy checks failed"
            exit 1
          fi
          echo "All crypto policy checks passed!"
