name: Intelligent PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  # Job 1: Semantic code review using claude-code-action
  code-review:
    if: >
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-5-20250929
          trigger_phrase: "@claude"
          timeout_minutes: 10
          custom_instructions: |
            You are reviewing a pull request for CryptoServe, an open-source cryptographic inventory and post-quantum readiness platform. Apply these domain-specific criteria:

            ## 1. Cryptographic Correctness (Critical)
            - Key material must never be logged, serialized to JSON, or returned in API responses
            - Algorithm identifiers must match IANA/NIST naming (e.g., ML-KEM-768, not kyber768)
            - Nonces/IVs must never be reused — check for deterministic generation patterns
            - Random values must use CSPRNG (secrets module, not random)
            - Key derivation must use appropriate KDFs (HKDF, Argon2) with proper salt handling
            - Certificate parsing must validate chain of trust, not just leaf cert

            ## 2. Security
            - No hardcoded secrets, API keys, or credentials
            - No eval(), exec(), pickle.loads() on untrusted input
            - SQL queries must use parameterized statements
            - User input must be validated before use in file paths, shell commands, or queries
            - Authentication/authorization checks must not be bypassable
            - Error messages must not leak internal state or stack traces to clients

            ## 3. SDK API Stability
            - Public function signatures in cryptoserve_core, cryptoserve_client, cryptoserve_auto must not change without a deprecation path
            - New required parameters on existing public functions are breaking changes — flag them
            - Type hints on public APIs must be present and accurate
            - __all__ exports must be updated when adding new public symbols

            ## 4. Test Coverage
            - New code paths should have corresponding tests
            - Cryptographic operations need both positive and negative test cases
            - Edge cases: empty input, maximum sizes, malformed data, expired certificates
            - Mock external services, do not make real network calls in tests

            ## 5. Code Quality
            - Functions over 50 lines should be examined for decomposition opportunities
            - Avoid deep nesting (>3 levels) — suggest early returns
            - Error handling should be specific (no bare except:)
            - Resource cleanup should use context managers (with statements)

            ## What to Skip
            - Style/formatting issues (ruff and black enforce these via CI)
            - Import ordering (handled by ruff)
            - Docstring style (not enforced in this project)
            - Minor naming preferences that don't affect clarity

  # Job 2: Security-focused review
  security-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      findings-count: ${{ steps.security.outputs.findings-count }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Run Security Review
        id: security
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-5-20250929
          timeout_minutes: 8
          direct_prompt: |
            Perform a security-focused review of this PR. Focus on:
            1. Injection vulnerabilities (SQL, command, path traversal)
            2. Authentication/authorization bypasses
            3. Insecure deserialization or eval usage
            4. Hardcoded credentials or secrets
            5. SSRF or open redirect risks
            6. Cryptographic misuse (weak algorithms, nonce reuse, key leakage)

            False positive suppressions:
            - Policy/gate files (*_gate.py, *_policies.py) reference algorithm names for detection, not usage
            - Test files may intentionally use weak cryptographic material as fixtures
            - crypto_audit.py references algorithms in documentation
            - Scanner output files contain algorithm names as scan results

            At the end, output a single line: FINDINGS_COUNT=N where N is the number of security issues found.

  # Job 3: Auto-merge safe PRs
  auto-merge:
    needs: [code-review, security-review]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Wait for CI checks
        uses: lewagon/wait-on-check-action@ccfb013c15c8afb7bf2b7c028fb74dc5a068cccc  # v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          check-regexp: ^(test|lint|frontend|sdk|security).*
          wait-interval: 30
          allowed-conclusions: success

      - name: Evaluate auto-merge eligibility
        id: evaluate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_CREATED: ${{ github.event.pull_request.created_at }}
          SECURITY_FINDINGS: ${{ needs.security-review.outputs.findings-count }}
        run: |
          set -euo pipefail

          ELIGIBLE=true
          REASONS=""

          # Condition 1: CI checks passed (handled by wait-on-check-action above)

          # Condition 2: Security review findings == 0
          FINDINGS="${SECURITY_FINDINGS:-unknown}"
          if [[ "$FINDINGS" != "0" && "$FINDINGS" != "" ]]; then
            ELIGIBLE=false
            REASONS="${REASONS}\n- Security review found issues (findings: ${FINDINGS})"
          fi

          # Condition 3: PR author is trusted
          TRUSTED_AUTHORS="dependabot[bot] renovate[bot] decimai"
          if ! echo "$TRUSTED_AUTHORS" | grep -qw "$PR_AUTHOR"; then
            ELIGIBLE=false
            REASONS="${REASONS}\n- PR author '${PR_AUTHOR}' is not in the trusted auto-merge list"
          fi

          # Condition 4: PR is small (<=10 files, <=200 lines changed)
          FILES_CHANGED=$(gh pr view "$PR_NUMBER" --json files --jq '.files | length')
          ADDITIONS=$(gh pr view "$PR_NUMBER" --json additions --jq '.additions')
          DELETIONS=$(gh pr view "$PR_NUMBER" --json deletions --jq '.deletions')
          TOTAL_LINES=$((ADDITIONS + DELETIONS))

          if [[ "$FILES_CHANGED" -gt 10 ]]; then
            ELIGIBLE=false
            REASONS="${REASONS}\n- Too many files changed (${FILES_CHANGED} > 10)"
          fi
          if [[ "$TOTAL_LINES" -gt 200 ]]; then
            ELIGIBLE=false
            REASONS="${REASONS}\n- Too many lines changed (${TOTAL_LINES} > 200)"
          fi

          # Condition 5: No changes to protected paths
          PROTECTED_PATHS=".github/workflows/ backend/app/core/crypto/ backend/app/auth/ sdk/python/packages/cryptoserve-core/cryptoserve_core/ .env docker-compose"
          CHANGED_FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path')
          for path in $PROTECTED_PATHS; do
            if echo "$CHANGED_FILES" | grep -q "^${path}"; then
              ELIGIBLE=false
              REASONS="${REASONS}\n- Changes to protected path: ${path}"
            fi
          done

          # Condition 6: PR is at least 5 minutes old (anti-rush)
          CREATED_EPOCH=$(date -d "$PR_CREATED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$PR_CREATED" +%s 2>/dev/null || echo 0)
          NOW_EPOCH=$(date +%s)
          AGE_MINUTES=$(( (NOW_EPOCH - CREATED_EPOCH) / 60 ))

          if [[ "$AGE_MINUTES" -lt 5 ]]; then
            ELIGIBLE=false
            REASONS="${REASONS}\n- PR is too new (${AGE_MINUTES} min < 5 min minimum)"
          fi

          echo "eligible=$ELIGIBLE" >> "$GITHUB_OUTPUT"
          echo "reasons<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$REASONS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Auto-merge PR
        if: steps.evaluate.outputs.eligible == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr review "$PR_NUMBER" --approve --body "Auto-approved: all CI checks passed, security review clean, small PR from trusted author."
          gh pr merge "$PR_NUMBER" --auto --squash

      - name: Post manual review notice
        if: steps.evaluate.outputs.eligible == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REASONS: ${{ steps.evaluate.outputs.reasons }}
        run: |
          BODY=$(cat <<'COMMENT'
          **Manual review required.** This PR did not meet auto-merge criteria:

          COMMENT
          )
          BODY="${BODY}${REASONS}"
          gh pr comment "$PR_NUMBER" --body "$BODY"
